---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import MathCapsule from '../../components/MathCapsule.jsx';
import MathJaxLoader from '../../components/MathJaxLoader.tsx';

// 1. Static posts from content/visual-problems
const staticPosts = await getCollection('visual-problems');

// 2. Interactive MDX modules from pages/visual-problems
const interactiveModules = import.meta.glob('./*.mdx', { eager: true });

const interactivePosts = Object.entries(interactiveModules).map(([path, mod]) => {
  const url = path
    .replace('./', '/visual-problems/')
    .replace('.mdx', '');
  return {
    url,
    ...(mod.frontmatter ?? {}),
  };
});

// 3. Normalize static post URLs too
const staticPostEntries = staticPosts.map(({ slug, data }) => ({
  url: `/visual-problems/${slug}`,
  ...data,
}));

// 4. Combine & sort
const allPosts = [...staticPostEntries, ...interactivePosts];
allPosts.sort((a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime());
---

<BaseLayout
  title="Problem Solving"
  description="Explore challenging math problems — from Putnam and GRE to interesting puzzles I’ve found along the way."
>
  <p>
    Explore challenging math problems — from Putnam and GRE to interesting
    puzzles I’ve found along the way. This is where I collect the questions
    that sent me down a rabbit hole and the ideas that helped unlock them.
  </p>

  <section class="archive">
    {Object.entries(
      allPosts.reduce((acc, post) => {
        const year = new Date(post.pubDate).getFullYear();
        (acc[year] ??= []).push(post);
        return acc;
      }, {})
    )
      .sort(([a], [b]) => Number(b) - Number(a))
      .map(([year, posts]) => (
        <div class="year" key={year}>
          <h2 class="yearTitle">{year}</h2>

          <div class="timeline">
            {posts.map((post) => (
              <article class="row" key={post.url}>
                <p class="date">
                  <em>{new Date(post.pubDate).toLocaleDateString()}</em>
                </p>

                <div>
                  <a class="title" href={post.url}>{post.title}</a>

                  {post.description && <p class="desc">{post.description}</p>}

                  {post.tags?.length ? (
                    <div class="tags" aria-label="tags">
                      {post.tags.map((t) => (
                        <span class="tag">[{t}]</span>
                      ))}
                    </div>
                  ) : null}
                </div>
              </article>
            ))}
          </div>
        </div>
      ))}
  </section>

  <style>
    .archive {
      margin-top: 2.5rem;
      max-width: 760px;
    }

    .year {
      margin-top: 3rem;
    }

    .yearTitle {
      font-size: 2.1rem;
      letter-spacing: -0.02em;
      margin: 0 0 1rem 0;
    }

    /* vertical reading guide (the trick) */
    .timeline {
      border-left: 1px solid rgba(0, 0, 0, 0.12);
      padding-left: 1.25rem;
    }

    .row {
      display: grid;
      grid-template-columns: max-content 1fr;
      column-gap: 1.25rem;
      padding: 0.9rem 0;
      align-items: start;
    }

    .row + .row {
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .date {
      margin: 0;
      opacity: 0.65;
      white-space: nowrap;
      padding-top: 0.15rem;
    }

    .title {
      display: inline-block;
      font-size: 1.25rem;
      line-height: 1.2;
      text-decoration: none;
      transition: 0.2s ease;
    }

    .title:hover {
      text-decoration: underline;
    }

    .desc {
      margin: 0.35rem 0 0;
      opacity: 0.78;
      line-height: 1.45;
    }

    /* annotation-style tags */
    .tags {
      margin-top: 0.35rem;
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      font-size: 0.95rem;
      opacity: 0.75;
    }

    .tag {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    @media (max-width: 520px) {
      .row {
        grid-template-columns: 1fr;
        row-gap: 0.25rem;
      }

      .yearTitle {
        font-size: 1.8rem;
      }

      .title {
        font-size: 1.1rem;
      }
    }
  </style>
</BaseLayout>

